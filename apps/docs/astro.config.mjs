// @ts-check
import starlight from '@astrojs/starlight';
import { defineConfig } from 'astro/config';
import starlightAutoSidebar from 'starlight-auto-sidebar';
import starlightTypeDoc from 'starlight-typedoc';

import angular from '@analogjs/astro-angular';
import umami from '@yeskunall/astro-umami';
import tailwindcss from '@tailwindcss/vite';

const UMAMI_WEBSITE_ID = process.env.UMAMI_WEBSITE_ID || '';

export default defineConfig({
  base: '/docs',
  redirects: {
    '/': '/docs/intro/quick-start/',
  },
  vite: {
    plugins: [tailwindcss()],
  },
  integrations: [
    umami({
      id: UMAMI_WEBSITE_ID,
    }),
    angular({
      vite: {
        transformFilter: (_code, id) => {
          return id.includes('src/components/angular');
        },
        inlineStylesExtension: 'scss|sass|less',
        include: ['@angular/compiler'],
        jit: true,
      },
    }),
    starlight({
      title: 'NgDiagram',
      logo: {
        light: './src/assets/ng-diagram-logo-black.svg',
        dark: './src/assets/ng-diagram-logo-white.svg',
      },
      customCss: ['./src/styles/custom.css'],
      social: [
        {
          icon: 'github',
          label: 'GitHub',
          href: 'https://github.com/synergycodes/ng-diagram',
        },
      ],
      sidebar: [
        {
          label: 'Intro',
          autogenerate: { directory: 'intro' },
        },
        {
          label: 'Guides',
          autogenerate: { directory: 'guides' },
          collapsed: true,
        },
        {
          label: 'Examples',
          autogenerate: { directory: 'examples' },
          collapsed: true,
        },
        // TODO: Enable this section after deploying yjs demo app
        // {
        //   label: 'Demos',
        //   link: '/demos/',
        // },
        {
          label: 'API',
          collapsed: true,
          items: [
            {
              label: 'Components',
              collapsed: true,
              autogenerate: { directory: 'api/Components' },
            },
            {
              label: 'Directives',
              collapsed: true,
              autogenerate: { directory: 'api/Directives' },
            },
            {
              label: 'Services',
              collapsed: true,
              autogenerate: { directory: 'api/Services' },
            },
            {
              label: 'Types',
              collapsed: true,
              autogenerate: { directory: 'api/Types' },
            },
            {
              label: 'Utilities',
              collapsed: true,
              autogenerate: { directory: 'api/Utilities' },
            },
            {
              label: 'Internals',
              collapsed: true,
              autogenerate: { directory: 'api/Internals' },
            },
            {
              label: 'Other',
              collapsed: true,
              autogenerate: { directory: 'api/Other' },
            },
          ],
        },
        {
          label: 'Policies',
          autogenerate: { directory: 'policies' },
          collapsed: true,
        },
        {
          label: 'Changelog',
          link: '/changelog/',
        },
      ],
      plugins: [
        starlightAutoSidebar(),
        starlightTypeDoc({
          entryPoints: ['../../packages/ng-diagram/projects/ng-diagram/src/public-api.ts'],
          tsconfig: '../../packages/ng-diagram/projects/ng-diagram/tsconfig.lib.json',
          typeDoc: {
            plugin: ['typedoc-plugin-frontmatter', './plugins/since-frontmatter.mjs'],
            // YAML stringify options for typedoc-plugin-frontmatter
            // Ensures consistent formatting with quoted values and unquoted keys
            // See: https://eemeli.org/yaml/#tostring-options
            // @ts-expect-error - yamlStringifyOptions is a valid option for typedoc-plugin-frontmatter
            yamlStringifyOptions: {
              defaultStringType: 'QUOTE_DOUBLE',
              defaultKeyType: 'PLAIN',
            },
            router: 'category',
            disableSources: true,
            excludeNotDocumented: true,
            // Temporary fix to remove autogenerated README from docs.
            // TypeDoc option `readme: undefined` is not supported by the plugin.
            entryFileName: '_readme',
            excludeInternal: true,
            excludePrivate: true,
          },
          watch: true,
        }),
      ],
      components: {
        SocialIcons: './src/components/social-icons/social-icons.astro',
        PageTitle: './src/components/page-title/page-title.astro',
        ThemeProvider: './src/components/ForceDarkTheme.astro',
        ThemeSelect: './src/components/ForceThemeSelect.astro',
      },
    }),
  ],
});
